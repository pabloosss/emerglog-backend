<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Generator Godzin RmLogistics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Bootstrap 5 -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
/>
  <!-- Font Awesome (opcjonalnie, jeśli chcesz ikony) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>
  <style>
    body {
      background-color: #f9f9f9;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    .container {
      margin-top: 30px;
      margin-bottom: 30px;
      max-width: 1000px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #333;
    }
    .header p {
      font-size: 16px;
      color: #555;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    .instructions ul {
      list-style: none;
      padding-left: 0;
    }
    .instructions ul li {
      margin-bottom: 8px;
      position: relative;
      padding-left: 25px;
    }
    .instructions ul li::before {
      content: "\f058";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      color: #0066cc;
      position: absolute;
      left: 0;
      top: -1px;
    }
    .final-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .final-table th,
    .final-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    .final-table thead th {
      background-color: #e0e0e0;
      font-weight: bold;
    }
    .final-table .holiday td {
      background-color: #ffcccc;
      color: #a00;
      font-weight: bold;
    }
    #exportButtons {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Główny nagłówek -->
  <div class="header">
    <h1>
      <span style="color: black;">Rm</span
      ><span style="color: blue;">Logistics</span> – Generator Godzin
    </h1>
    <p>Wypełnij dane i wybierz rodzaj umowy. Po wygenerowaniu PDF zostanie wysłany na e-mail Pawła.</p>
    <button class="btn btn-dark" onclick="window.location.href='/admin'">
      Strefa Admina
    </button>
  </div>

  <!-- Instrukcja -->
  <div class="card mb-4">
    <h5><i class="fas fa-info-circle"></i> Instrukcja</h5>
    <div class="instructions">
      <ul>
        <li>Wybierz rodzaj umowy:
          <ul>
            <li><strong>Umowa zlecenie</strong> – godziny generowane losowo, opcja "Losowe dni wolne" jest obowiązkowa.</li>
            <li><strong>Umowa o pracę (pełny etat)</strong> – stałe godziny: 8:00–16:00.</li>
            <li><strong>Umowa o pracę (3/4 etatu)</strong> – stałe godziny: 8:00–14:00 + (opcjonalnie) wniosek urlopowy.</li>
          </ul>
        </li>
        <li>Dla umowy zlecenie wpisz łączną liczbę godzin. Dla umowy o pracę to pole jest ukryte.</li>
        <li>Wybierz miesiąc i rok, dodaj (opcjonalnie) ręcznie dni wolne.</li>
        <li>Opcja „Losowe dni wolne” jest wymuszona przy zleceniu i dowolna przy umowach o pracę.</li>
        <li>Po kliknięciu "Generuj i wyślij", harmonogram PDF zostanie automatycznie wysłany na <em>pawel.ruchlicki@emerlog.eu</em>.</li>
      </ul>
    </div>
  </div>

  <!-- Formularz -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="generatorForm" novalidate>
        <!-- Rodzaj umowy -->
        <div class="mb-3">
          <label class="form-label">Rodzaj umowy</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contractZlecenie" value="zlecenie" checked>
            <label class="form-check-label" for="contractZlecenie">Umowa zlecenie</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contractPraca" value="praca">
            <label class="form-check-label" for="contractPraca">Umowa o pracę (pełny etat)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="contractType" id="contract34" value="praca3/4">
            <label class="form-check-label" for="contract34">Umowa o pracę (3/4 etatu)</label>
          </div>
        </div>

        <!-- Checkbox wniosku urlopowego (3/4) -->
        <div class="mb-3 form-check" id="vacationRequestGroup" style="display:none;">
          <input type="checkbox" class="form-check-input" id="generateVacation">
          <label class="form-check-label" for="generateVacation">Wygeneruj wniosek urlopowy</label>
        </div>

        <div class="row">
          <!-- Imię i nazwisko -->
          <div class="col-md-6 mb-3 form-group required">
            <label for="name" class="form-label">Imię i nazwisko</label>
            <input type="text" class="form-control" id="name" required>
            <div class="invalid-feedback">Wpisz imię i nazwisko!</div>
          </div>
          <!-- Łączna liczba godzin (tylko przy zleceniu) -->
          <div class="col-md-6 mb-3 form-group required" id="hoursGroup">
            <label for="hours" class="form-label">Łączna liczba godzin</label>
            <input type="number" class="form-control" id="hours" min="1" required>
            <div class="invalid-feedback">Wpisz liczbę godzin (min 1)!</div>
          </div>
        </div>

        <div class="row">
          <!-- Miesiąc -->
          <div class="col-md-4 mb-3">
            <label for="month" class="form-label">Miesiąc</label>
            <select id="month" class="form-select" required>
              <option value="">Wybierz...</option>
              <option value="1">Styczeń</option>
              <option value="2">Luty</option>
              <option value="3">Marzec</option>
              <option value="4">Kwiecień</option>
              <option value="5">Maj</option>
              <option value="6">Czerwiec</option>
              <option value="7">Lipiec</option>
              <option value="8">Sierpień</option>
              <option value="9">Wrzesień</option>
              <option value="10">Październik</option>
              <option value="11">Listopad</option>
              <option value="12">Grudzień</option>
            </select>
            <div class="invalid-feedback">Wybierz miesiąc!</div>
          </div>
          <!-- Rok -->
          <div class="col-md-4 mb-3">
            <label for="year" class="form-label">Rok</label>
            <input type="number" class="form-control" id="year" min="1900" value="2025" required>
            <div class="invalid-feedback">Podaj rok (np. 2025)!</div>
          </div>
          <div class="col-md-4 mb-3">
            <small class="form-text">Praca kończy się zawsze przed 20:00.</small>
          </div>
        </div>

        <!-- Dodatkowe dni wolne -->
        <div class="mb-3">
          <label class="form-label">Dodatkowe dni wolne</label>
          <div class="input-group">
            <input type="date" class="form-control" id="holidayPicker">
            <button type="button" class="btn btn-secondary" id="addHoliday">Dodaj wolne</button>
          </div>
          <ul class="holidays-list" id="holidaysList"></ul>
        </div>

        <!-- Losowe dni wolne -->
        <div class="mb-3 form-check" id="randomHolidaysGroup">
          <input type="checkbox" class="form-check-input" id="randomHolidays">
          <label class="form-check-label" for="randomHolidays">Dodaj losowo dni wolne</label>
        </div>

        <!-- Przycisk generowania/ wysyłania -->
        <button type="submit" class="btn btn-primary w-100">
          Generuj i wyślij
        </button>
      </form>
    </div>
  </div>

  <!-- Tu pojawi się tabela z godzinami -->
  <div id="output" class="table-responsive"></div>
  <!-- Przycisk pobrania PDF (lokalnie) -->
  <div id="exportButtons" style="display:none;">
    <button id="generatePDF" class="btn btn-success mt-3">Pobierz PDF</button>
  </div>
</div>

<footer class="text-center text-muted mb-4">
  &copy; 2023 RmLogistics – Generator Godzin
</footer>

<!-- Biblioteki JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/*
  Wzorowane na starym Emerlog Generator, 
  ale mail zawsze idzie do: pawel.ruchlicki@emerlog.eu
  + mamy przycisk do Admina
*/

// Parametry
const FIRST_WORKING_DAYS = {}; // Możesz dopisać np. {2025:{4:1}} itp., jeśli chcesz
const fixedHolidays = [
  "01-01","06-01","20-04","21-04",
  "01-05","03-05","08-06","19-06",
  "15-08","01-11","11-11","25-12","26-12"
];
window.customHolidays = []; // Ręcznie dodane
window.randomFreeDaysAdded = [];

const MAX_HOURS_PER_DAY = 12;
const MIN_HOURS_PER_DAY = 4;

// Obsługa switcha formy
document.querySelectorAll('input[name="contractType"]').forEach(input => {
  input.addEventListener("change", () => {
    const type = document.querySelector('input[name="contractType"]:checked').value;
    if (type === "praca" || type === "praca3/4") {
      document.getElementById("hoursGroup").style.display = "none";
      document.getElementById("hours").required = false;
      document.getElementById("vacationRequestGroup").style.display = (type === "praca3/4") ? "block" : "none";

      document.getElementById("randomHolidays").disabled = false;
      document.getElementById("randomHolidays").checked = false;
    } else {
      document.getElementById("hoursGroup").style.display = "block";
      document.getElementById("hours").required = true;
      document.getElementById("vacationRequestGroup").style.display = "none";

      document.getElementById("randomHolidays").checked = true;
      document.getElementById("randomHolidays").disabled = true;
    }
  });
});

// Ustawienia min/max dat
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("generatorForm");
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!form.checkValidity()) {
      e.stopPropagation();
    } else {
      // Najpierw generujemy i pokazujemy tabelę
      generateTable();
      // Następnie wysyłamy PDF na backend
      await sendPDF();
    }
    form.classList.add("was-validated");
  });

  // Dodawanie dni wolnych
  const addHolidayBtn = document.getElementById("addHoliday");
  addHolidayBtn.addEventListener("click", () => {
    const selDate = document.getElementById("holidayPicker").value;
    if (!selDate) {
      alert("Wybierz datę!");
      return;
    }
    if (!window.customHolidays.includes(selDate)) {
      window.customHolidays.push(selDate);
      renderHolidays();
    }
  });

  function renderHolidays() {
    const holidaysListEl = document.getElementById("holidaysList");
    holidaysListEl.innerHTML = "";
    window.customHolidays.forEach(h => {
      const li = document.createElement("li");
      li.textContent = h;
      const btn = document.createElement("button");
      btn.classList.add("btn","btn-sm","btn-danger","ms-2");
      btn.textContent = "Usuń";
      btn.addEventListener("click", () => {
        window.customHolidays = window.customHolidays.filter(x => x !== h);
        renderHolidays();
      });
      li.appendChild(btn);
      holidaysListEl.appendChild(li);
    });
  }

  const monthEl = document.getElementById("month");
  const yearEl = document.getElementById("year");
  monthEl.addEventListener("change", updateHolidayPickerRange);
  yearEl.addEventListener("change", updateHolidayPickerRange);

  function updateHolidayPickerRange() {
    const mVal = parseInt(monthEl.value, 10);
    const yVal = parseInt(yearEl.value, 10);
    const holidayPicker = document.getElementById("holidayPicker");
    if (!mVal || !yVal) {
      holidayPicker.removeAttribute("min");
      holidayPicker.removeAttribute("max");
      return;
    }
    const daysInMonth = new Date(yVal, mVal, 0).getDate();
    const mm = String(mVal).padStart(2, '0');
    const minDate = `${yVal}-${mm}-01`;
    const maxDate = `${yVal}-${mm}-${daysInMonth}`;
    holidayPicker.setAttribute("min", minDate);
    holidayPicker.setAttribute("max", maxDate);
    if (holidayPicker.value) {
      if (holidayPicker.value < minDate || holidayPicker.value > maxDate) {
        holidayPicker.value = "";
      }
    }
  }
});

// Funkcje generujące
function isHoliday(day, month, year) {
  const dd = String(day).padStart(2,"0");
  const mm = String(month).padStart(2,"0");
  const yyyy = String(year).padStart(4,"0");
  const fullDate = `${yyyy}-${mm}-${dd}`;
  const shortDate = `${dd}-${mm}`;
  if (window.customHolidays.includes(fullDate)) return true;
  if (fixedHolidays.includes(shortDate)) return true;
  return false;
}
function shuffleArray(arr){
  for (let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}
function getRandomInt(min,max){
  return Math.floor(Math.random()*(max-min+1))+min;
}
function distributeHours(totalHours,daysCount){
  if (daysCount===0) return null;
  const maxPossible=MAX_HOURS_PER_DAY*daysCount;
  const minPossible=MIN_HOURS_PER_DAY*daysCount;
  if(totalHours>maxPossible){alert(`Za dużo godzin (max ${maxPossible})!`);return null;}
  if(totalHours<minPossible){alert(`Za mało godzin (min ${minPossible})!`);return null;}

  let arr=new Array(daysCount).fill(MIN_HOURS_PER_DAY);
  let leftover=totalHours-(daysCount*MIN_HOURS_PER_DAY);
  let base=Math.floor(leftover/daysCount);
  let rem=leftover%daysCount;
  for(let i=0;i<daysCount;i++){arr[i]+=base;}
  let idxs=[...Array(daysCount).keys()];
  shuffleArray(idxs);
  for(let i=0;i<rem;i++){
    for(let j=0;j<daysCount;j++){
      if(arr[idxs[j]]<MAX_HOURS_PER_DAY){
        arr[idxs[j]]++;
        break;
      }
    }
  }
  // Korekty
  let adjustments=Math.min(Math.ceil(daysCount*0.3),8);
  for(let k=0;k<adjustments;k++){
    let dayIndex=Math.floor(Math.random()*daysCount);
    let sign=Math.random()<0.5?-1:1;
    let newVal=arr[dayIndex]+sign;
    if(newVal>=MIN_HOURS_PER_DAY && newVal<=MAX_HOURS_PER_DAY){
      arr[dayIndex]=newVal;
    }
  }
  let diff=totalHours-arr.reduce((a,b)=>a+b,0);
  if(diff!==0){
    for(let i=0;i<daysCount && diff!==0;i++){
      if(diff>0 && arr[i]<MAX_HOURS_PER_DAY){
        let canAdd=Math.min(diff,MAX_HOURS_PER_DAY-arr[i]);
        arr[i]+=canAdd;diff-=canAdd;
      }else if(diff<0 && arr[i]>MIN_HOURS_PER_DAY){
        let canRem=Math.min(Math.abs(diff),arr[i]-MIN_HOURS_PER_DAY);
        arr[i]-=canRem;diff+=canRem;
      }
    }
  }
  let finalSum=arr.reduce((a,b)=>a+b,0);
  if(finalSum!==totalHours){
    alert("Nie udało się dopasować godzin do wskazanej sumy.");
    return null;
  }
  return arr;
}
function formatDate(date){
  const d=String(date.getDate()).padStart(2,'0');
  const m=String(date.getMonth()+1).padStart(2,'0');
  const y=date.getFullYear();
  return `${d}.${m}.${y}`;
}
function groupDates(dates){
  if(!dates.length)return[];
  let groups=[];
  let groupStart=dates[0],groupEnd=dates[0];
  for(let i=1;i<dates.length;i++){
    let current=dates[i];
    if(current-groupEnd===86400000){
      groupEnd=current;
    }else{
      groups.push({start:groupStart,end:groupEnd});
      groupStart=current;groupEnd=current;
    }
  }
  groups.push({start:groupStart,end:groupEnd});
  return groups;
}

function generateTable(){
  window.randomFreeDaysAdded=[];
  const name=document.getElementById("name").value.trim();
  const type=document.querySelector('input[name="contractType"]:checked').value;
  const monthVal=parseInt(document.getElementById("month").value,10);
  const yearVal=parseInt(document.getElementById("year").value,10);
  const addRandom=document.getElementById("randomHolidays").checked;
  const genVacation=document.getElementById("generateVacation").checked;

  if(!name||!monthVal||!yearVal){alert("Wypełnij wszystkie pola!");return;}

  let totalHours=0;
  if(type==="zlecenie"){
    totalHours=parseInt(document.getElementById("hours").value,10);
    if(!totalHours||totalHours<1){alert("Podaj liczbę godzin > 0!");return;}
  }
  const daysInMonth=new Date(yearVal,monthVal,0).getDate();
  let dayData=[];
  for(let d=1;d<=daysInMonth;d++){
    const dateObj=new Date(yearVal,monthVal-1,d);
    const weekend=[0,6].includes(dateObj.getDay());
    const holiday=isHoliday(d,monthVal,yearVal);
    dayData.push({
      day:d,
      date:dateObj,
      isWorkingDay:(!weekend&&!holiday),
      hours:0,
      start:"-",
      end:"-",
      randomHoliday:false
    });
  }
  // Losowe wolne (zlec.)
  if(type==="zlecenie" && addRandom){
    const freeDaysPattern=[0,1,3,1,0,0];
    let grouped={};
    dayData.forEach(day=>{
      const week=Math.floor((day.day-1)/7)+1;
      if(!grouped[week]) grouped[week]=[];
      grouped[week].push(day);
    });
    Object.keys(grouped).forEach(weekKey=>{
      const weekDays=grouped[weekKey];
      const workingInWeek=weekDays.filter(d=>d.isWorkingDay);
      let required=freeDaysPattern[parseInt(weekKey)-1]||0;
      required=Math.min(required,workingInWeek.length);
      if(required>0){
        const shuffled=workingInWeek.sort(()=>0.5-Math.random());
        const selected=shuffled.slice(0,required);
        selected.forEach(day=>{
          day.isWorkingDay=false;
          day.hours=0;
          day.start="-";
          day.end="-";
          day.randomHoliday=true;
          window.randomFreeDaysAdded.push(day);
        });
      }
    });
  }

  let workingDays=dayData.filter(d=>d.isWorkingDay);
  if(type==="praca"){
    workingDays.forEach(day=>{
      day.hours=8;
      day.start="8:00";
      day.end="16:00";
    });
  } else if(type==="praca3/4"){
    workingDays.forEach(day=>{
      day.hours=6;
      day.start="8:00";
      day.end="14:00";
    });
  } else if(type==="zlecenie"){
    let arr=distributeHours(totalHours,workingDays.length);
    if(!arr)return;
    for(let i=0;i<workingDays.length;i++){
      let h=arr[i];
      let wd=workingDays[i];
      let maxStart=20-h;
      let sH=getRandomInt(6,maxStart);
      let eH=sH+h;
      if(eH>20){alert(`Dzień ${wd.day}: koniec po 20:00!`);return;}
      wd.hours=h;
      wd.start=sH+":00";
      wd.end=eH+":00";
    }
  }

  // Sum
  const sumOfHours=workingDays.reduce((acc,d)=>acc+d.hours,0);

  // Generowanie HTML
  const tableHTML=createScheduleHTML(dayData,monthVal,yearVal,name,type,sumOfHours,genVacation);

  document.getElementById("output").innerHTML=tableHTML;
  document.getElementById("exportButtons").style.display="block";
}

// Tworzy HTML tabeli + ewentualnie wniosek
function createScheduleHTML(dayData,monthVal,yearVal,fullName,contractType,sumOfHours,genVacation){
  const monthNames=["Styczeń","Luty","Marzec","Kwiecień","Maj","Czerwiec","Lipiec","Sierpień","Wrzesień","Październik","Listopad","Grudzień"];
  let contractDesc="";
  if(contractType==="praca") contractDesc="Umowa o pracę (8:00 - 16:00)";
  else if(contractType==="praca3/4") contractDesc="Umowa o pracę (3/4 etatu, 8:00 - 14:00)";
  else contractDesc="Umowa zlecenie (losowe)";

  let rows=dayData.map(d=>{
    const dd=String(d.day).padStart(2,"0");
    const mm=String(monthVal).padStart(2,"0");
    const yyyy=yearVal;
    const weekday=d.date.toLocaleString("pl-PL",{weekday:"short"});
    if(d.isWorkingDay && d.hours>0){
      return `
      <tr>
        <td>${d.day}</td>
        <td>${dd}.${mm}.${yyyy} (${weekday})</td>
        <td>${d.start}</td>
        <td>${d.end}</td>
        <td>${d.hours}</td>
        <td>${fullName.split(" ").slice(1).join(" ")}</td>
        <td></td>
      </tr>`;
    } else {
      return `
      <tr class="holiday">
        <td>${d.day}</td>
        <td>${dd}.${mm}.${yyyy} (${weekday})</td>
        <td>-</td>
        <td>-</td>
        <td>0</td>
        <td>${fullName.split(" ").slice(1).join(" ")}</td>
        <td></td>
      </tr>`;
    }
  });
  rows.push(`
    <tr class="fw-bold">
      <td colspan="4">Suma godzin:</td>
      <td>${sumOfHours}</td>
      <td colspan="2"></td>
    </tr>
  `);

  let html=`
    <h3 class="mt-4">${monthNames[monthVal-1]} ${yearVal}</h3>
    <h4>${fullName}</h4>
    <p><strong>Rodzaj umowy:</strong> ${contractDesc}</p>
    <table class="final-table">
      <thead>
        <tr>
          <th>Dzień</th>
          <th>Data</th>
          <th>Godz. rozpoczęcia</th>
          <th>Godz. zakończenia</th>
          <th>Suma godzin</th>
          <th>Podpis zleceniobiorcy</th>
          <th>Podpis zleceniodawcy</th>
        </tr>
      </thead>
      <tbody>
      ${rows.join("")}
      </tbody>
    </table>
  `;

  // Wniosek urlopowy (zlecenie z random wolnymi lub praca3/4 z check + wolne)
  const hasRandomFree=(contractType==="zlecenie" && window.randomFreeDaysAdded.length>0);
  const has34Vacation=(contractType==="praca3/4" && genVacation && window.randomFreeDaysAdded.length>0);
  if(hasRandomFree||has34Vacation){
    html+=`
    <div id="vacationRequest" style="display:none; margin:20px auto; max-width:600px;font-family:Arial,sans-serif;">
      <h3 style="text-align:center;font-weight:bold;margin-bottom:20px;">WNIOSEK URLOPOWY</h3>
      <p><strong>Firma:</strong> RmLogistics Sp. z o.o.</p>
      <p><strong>Imię i nazwisko:</strong> ${fullName}</p>
      <p><strong>Data wystawienia:</strong> ${new Date().toLocaleDateString("pl-PL")}</p>
      <p><strong>Dni wolne:</strong> (zaznaczone w harmonogramie)</p>
      <p style="margin-top:20px;">Podpis: ________________________</p>
    </div>
    `;
  }
  return html;
}

// Generowanie PDF i wysyłanie do backendu
async function sendPDF(){
  const name=document.getElementById("name").value.trim();
  const contractType=document.querySelector('input[name="contractType"]:checked').value;
  let hours=0;
  if(contractType==="zlecenie"){
    hours=parseInt(document.getElementById("hours").value,10)||0;
  }
  const payload={ name, hours };
  console.log("Wysyłka do /send-pdf:",payload);

  try{
    const resp=await fetch("/send-pdf",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const data=await resp.json();
    alert(data.message||"PDF wysłany!");
  }catch(err){
    console.error("Błąd fetch /send-pdf:",err);
    alert("Błąd wysyłania PDF!");
  }
}

// Pobieranie PDF (lokalnie, bez maila)
async function downloadPDF(){
  console.log("downloadPDF triggered");
  const {jsPDF} = window.jspdf;
  const pdf=new jsPDF("portrait","pt","a4");
  const margin=20;
  const pageWidth=pdf.internal.pageSize.getWidth();
  const pageHeight=pdf.internal.pageSize.getHeight();

  // Logo
  const logoImg=new Image();
  logoImg.src="https://tsldada.pl/wp-content/uploads/2021/03/0000-00-team-emerlog-logo.png";
  await new Promise(r=>{logoImg.onload=r;});
  let desiredLogoWidth=150;
  let desiredLogoHeight=logoImg.height*(desiredLogoWidth/logoImg.width);
  if(!desiredLogoHeight||desiredLogoHeight<=0||Number.isNaN(desiredLogoHeight)){
    desiredLogoHeight=50;
  }
  const posX_logo=margin,posY_logo=margin;
  pdf.addImage(logoImg,"PNG",posX_logo,posY_logo,desiredLogoWidth,desiredLogoHeight);

  const outputEl=document.getElementById("output");
  if(!outputEl){alert("Brak #output!");return;}

  // screenshot
  const canvas=await html2canvas(outputEl,{scale:2, useCORS:true, allowTaint:false});
  const tableImgData=canvas.toDataURL("image/png");
  const availableWidth=pageWidth-2*margin;
  const availableHeight=pageHeight-(margin+desiredLogoHeight+margin);
  const ratio=Math.min(availableWidth/canvas.width,availableHeight/canvas.height);
  let finalW=canvas.width*ratio;
  let finalH=canvas.height*ratio;
  if(!finalW||finalW<=0||Number.isNaN(finalW)){finalW=canvas.width;}
  if(!finalH||finalH<=0||Number.isNaN(finalH)){finalH=canvas.height;}

  let posX_table=(pageWidth-finalW)/2;
  let posY_table=margin+desiredLogoHeight+(availableHeight-finalH)/2;
  if(posX_table<margin)posX_table=margin;
  if(posY_table<margin+desiredLogoHeight)posY_table=margin+desiredLogoHeight;

  pdf.addImage(tableImgData,"PNG",posX_table,posY_table,finalW,finalH);

  pdf.save("Tabela_Godzinowa_Pion.pdf");
}
</script>
</body>
</html>
